# WALL-E Navigation Stack: Quick Fix Implementation Guide

> **Note:** This implementation guide was generated by Claude AI as part of the ROS2 workspace review.

## Critical Issues Summary

| Issue | Root Cause | Impact | Fix Effort |
|-------|-----------|--------|-----------|
| Antenna blocks movement | Inflation radius 0.24m, antenna visible to LiDAR | Robot frozen when antenna in FOV | 30 min |
| Update rate misses | MPPI batch size 2000 + 20Hz = 50% CPU | Costmap stale, TF2 lag | 15 min |
| TF2 transforms lag | Roboclaw + EKF both publish odom->base_link | Race condition, unpredictable | 30 min |
| 50m navigation fails | Costmap only 20m range, GPS +2-5m error | Planner unreachable goal | 45 min |
| Garbage maps outside FOV | ICP scan matcher not fused to EKF | Odometry drifts | 1 hour |

---

## Phase 1: Critical Fixes (Do These First - 1.5 Hours)

### Fix #1: Reduce Inflation Radius (15 minutes)

**File:** `/home/ndev/WALL-E/ros2_ws/src/robot_navigation/config/nav2_no_map_params.yaml`

**Lines 191-193 (local costmap):**
```yaml
# CHANGE FROM:
inflation_layer:
  plugin: "nav2_costmap_2d::InflationLayer"
  cost_scaling_factor: 3.0
  inflation_radius: 0.24

# CHANGE TO:
inflation_layer:
  plugin: "nav2_costmap_2d::InflationLayer"
  cost_scaling_factor: 2.0
  inflation_radius: 0.15
```

**Lines 233-236 (global costmap):**
```yaml
# CHANGE FROM:
inflation_layer:
  plugin: "nav2_costmap_2d::InflationLayer"
  cost_scaling_factor: 3.0
  inflation_radius: 0.24

# CHANGE TO:
inflation_layer:
  plugin: "nav2_costmap_2d::InflationLayer"
  cost_scaling_factor: 2.0
  inflation_radius: 0.15
```

**Why:** Antenna no longer blocks all movement. Reduces blockage from 0.54m radius to 0.39m radius.

**Test:** `ros2 topic pub -1 /cmd_vel geometry_msgs/Twist "{linear: {x: 0.1}}"`

---

### Fix #2: Reduce MPPI Controller Batch Size (15 minutes)

**File:** `/home/ndev/WALL-E/ros2_ws/src/robot_navigation/config/nav2_no_map_params.yaml`

**Lines 62-64:**
```yaml
# CHANGE FROM:
time_steps: 56
model_dt: 0.05
batch_size: 2000

# CHANGE TO:
time_steps: 24
model_dt: 0.05
batch_size: 500
```

**Why:** Reduces CPU load from 50% to ~15%. Controller still works for 50m local navigation.

**Impact:** Costmap updates no longer miss, EKF runs steadily.

---

### Fix #3: Fix TF2 Transform Conflicts (30 minutes)

**Problem:** Both Roboclaw and EKF publish `odom->base_link`, causing race condition.

**Solution:** Let EKF be authoritative.

**File:** `/home/ndev/WALL-E/ros2_ws/src/roboclaw_driver/roboclaw_driver/roboclaw_node.py`

**Around line 113 (where TF2 broadcaster created):**

Find lines that look like:
```python
self.tf_broadcaster = TransformBroadcaster(self)
# ... code that publishes odom->base_link
```

**Action:** Comment out TF broadcasting. Keep odometry publishing (EKF needs it).

```python
# TF2 broadcasting disabled - EKF publishes odom->base_link
# self.tf_broadcaster = TransformBroadcaster(self)
```

**Verify After Restart:**
```bash
ros2 run tf2_tools tf2_monitor
# Should show single path: map -> odom -> base_link
# NOT: two separate odom->base_link publishers
```

---

## Phase 2: Parameter Tuning (45 minutes)

### Tune #1: Costmap Update Frequencies

**File:** `/home/ndev/WALL-E/ros2_ws/src/robot_navigation/config/nav2_no_map_params.yaml`

**Lines 161-162 (local costmap):**
```yaml
# CHANGE FROM:
update_frequency: 5.0
publish_frequency: 3.0

# CHANGE TO:
update_frequency: 10.0
publish_frequency: 5.0
```

**Lines 199-200 (global costmap):**
```yaml
# CHANGE FROM:
update_frequency: 1.0
publish_frequency: 0.5

# CHANGE TO:
update_frequency: 2.0
publish_frequency: 1.0
```

**Line 34 (controller frequency):**
```yaml
# CHANGE FROM:
controller_frequency: 20.0

# CHANGE TO:
controller_frequency: 10.0
```

**Why:** Synchronizes controller with costmap updates. Eliminates stale data problem.

---

### Tune #2: Obstacle Detection Ranges

**File:** `/home/ndev/WALL-E/ros2_ws/src/robot_navigation/config/nav2_no_map_params.yaml`

**Lines 178-189 (local costmap obstacle layer):**
```yaml
# CHANGE FROM:
scan:
  topic: /scan
  max_obstacle_height: 2.0
  clearing: True
  marking: True
  data_type: "LaserScan"
  raytrace_max_range: 10.0
  raytrace_min_range: 0.0
  obstacle_max_range: 8.0
  obstacle_min_range: 0.30

# CHANGE TO:
scan:
  topic: /scan
  max_obstacle_height: 2.0
  clearing: True
  marking: True
  data_type: "LaserScan"
  raytrace_max_range: 5.0
  raytrace_min_range: 0.0
  obstacle_max_range: 4.5
  obstacle_min_range: 0.10
```

**Lines 221-232 (global costmap obstacle layer):**
```yaml
# CHANGE FROM:
scan:
  topic: /scan
  max_obstacle_height: 2.0
  clearing: True
  marking: True
  data_type: "LaserScan"
  raytrace_max_range: 25.0
  raytrace_min_range: 0.0
  obstacle_max_range: 20.0
  obstacle_min_range: 0.30

# CHANGE TO:
scan:
  topic: /scan
  max_obstacle_height: 2.0
  clearing: True
  marking: True
  data_type: "LaserScan"
  raytrace_max_range: 12.0
  raytrace_min_range: 0.0
  obstacle_max_range: 10.0
  obstacle_min_range: 0.10
```

**Why:** Matches actual S-Lidar S3 range (~5.5m in sunlight). obstacle_min_range 0.10m catches antenna but excludes noise.

---

### Tune #3: Scan Matcher Reduction

**File:** `/home/ndev/WALL-E/ros2_ws/src/scan_matcher/config/scan_matcher_params.yaml`

**Lines 16-23:**
```yaml
# CHANGE FROM:
max_iterations: 20
tolerance: 1e-4
max_correspondence_distance: 0.5
downsample_factor: 2

# CHANGE TO:
max_iterations: 10
tolerance: 1e-3
max_correspondence_distance: 0.25
downsample_factor: 4
```

**Why:** ICP still runs but 75% faster. Stops blocking EKF/costmap updates.

---

## Phase 3: Build & Test (30 minutes)

### Step 1: Rebuild Docker Image

```bash
cd /home/ndev/WALL-E/docker
./start_docker.sh --build
```

Wait for build to complete (~5 minutes on Jetson).

### Step 2: Start System

```bash
./start_docker.sh --start
```

### Step 3: Verify Fixes in Container

```bash
# Terminal 1: Start system
docker exec -it <container_id> ros2 launch robot_navigation gps_waypoint_follower.launch.py

# Terminal 2: Monitor CPU
docker exec -it <container_id> top
# Look for: CPU usage < 40% (before was 60-80%)

# Terminal 3: Monitor update rates
docker exec -it <container_id> bash
ros2 topic hz /local_costmap/costmap_raw    # Should be ~10Hz
ros2 topic hz /cmd_vel_nav                  # Should be ~10Hz
ros2 topic hz /odometry/local               # Should be ~20Hz

# Terminal 4: Test antenna clearance
docker exec -it <container_id> bash
# Send forward velocity command
ros2 topic pub -1 /cmd_vel geometry_msgs/Twist "{linear: {x: 0.1}}"
# Expected: Robot moves forward, NO collision warnings

# Terminal 5: Test TF2
docker exec -it <container_id> bash
ros2 run tf2_tools tf2_monitor
# Expected: Single tree map -> odom -> base_link
```

---

## Phase 4: Full Test Navigation (30 minutes)

### Test 1: Local Antenna Clearance

1. Robot starts in clear area
2. Send `cmd_vel` forward: `ros2 topic pub -1 /cmd_vel geometry_msgs/Twist "{linear: {x: 0.1}}"`
3. Verify:
   - No "collision detected" messages in logs
   - Robot moves smoothly
   - Can rotate without error

**Expected Result:** PASS (antenna no longer blocks)

### Test 2: 20m Waypoint Navigation

1. Set waypoint 20m away in `waypoints.yaml`
2. Launch waypoint follower
3. Monitor:
   - `ros2 topic echo /navigation_feedback` shows progress
   - Costmap updates without gaps
   - Controller rate steady ~10Hz

**Expected Result:** PASS (waypoint reached without timeout)

### Test 3: 50m Waypoint Navigation

1. Set waypoint 50m away
2. Launch waypoint follower
3. Monitor replanning: should be minimal
4. Check goal achievement

**Expected Result:** PASS (reaches waypoint with maybe 1-2 replans due to rolling costmap)

### Test 4: CPU Load Verification

```bash
docker exec -it <container_id> top -b -n 1 | grep "Cpu"
# BEFORE changes: ~75% CPU
# AFTER changes: ~35% CPU
```

**Expected Result:** >40% reduction in CPU usage

---

## Rollback Plan

If something breaks:

```bash
# Revert individual files
cd /home/ndev/WALL-E
git checkout ros2_ws/src/robot_navigation/config/nav2_no_map_params.yaml
git checkout ros2_ws/src/scan_matcher/config/scan_matcher_params.yaml
# etc.

# Rebuild
cd docker
./start_docker.sh --build
```

---

## Quick Reference: All Changes

| File | Lines | Change | Reason |
|------|-------|--------|--------|
| nav2_no_map_params.yaml | 62-64 | batch_size: 2000 -> 500 | CPU load |
| nav2_no_map_params.yaml | 191-193, 233-236 | inflation_radius: 0.24 -> 0.15 | Antenna blockage |
| nav2_no_map_params.yaml | 161-162, 199-200 | costmap update_frequency | Sync with controller |
| nav2_no_map_params.yaml | 34 | controller_frequency: 20 -> 10 | Match costmap rate |
| nav2_no_map_params.yaml | 178-189, 221-232 | raytrace_max_range, obstacle_min_range | Realistic ranges |
| scan_matcher_params.yaml | 16-23 | max_iterations: 20 -> 10 | CPU load |
| roboclaw_node.py | ~113 | Comment TF broadcaster | Remove conflict |

---

## Questions for Diagnosis

Before you start, answer these:

1. **Does robot move at all currently?**
   - If NO: antenna definitely blocking (Fix #1 required)
   - If YES: test cost

2. **How long does system run before freezing?**
   - < 30s: CPU overload (Fix #2 required)
   - > 5min: something else

3. **Does `ros2 run tf2_tools tf2_monitor` show single odom->base_link or multiple?**
   - Multiple: Fix #3 required
   - Single: TF2 OK

4. **Is costmap updating smoothly? (`ros2 topic hz /local_costmap/costmap_raw`)**
   - Drops: CPU overload (Fixes #2, #1 needed)
   - Steady: OK

---

## Success Criteria

After implementation:

- [ ] Robot moves forward without antenna blocking movement
- [ ] CPU usage < 40% sustained (`top` command)
- [ ] TF2 shows single tree: `ros2 run tf2_tools tf2_monitor`
- [ ] All topics update at target frequency with <5% jitter
- [ ] 20m waypoint navigation reaches goal
- [ ] 50m waypoint navigation completes (may replan 1-2 times)
- [ ] No "transform timeout" or "collision_monitor" spam in logs

---

**Estimated Total Time:** 3-4 hours (including rebuild and testing)

**Risk Level:** LOW (all changes are parameter tuning + one simple code comment)

**Rollback Difficulty:** EASY (git checkout any file)

