<!DOCTYPE html>
<html>
<head>
    <title>WALLE: Control Panel</title>
    <style>
        #joystick-zone {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            touch-action: none;
            border: 2px solid #ccc;
            border-radius: 50%;
            position: relative;
        }
        #manual-control {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #manual-control.active {
            background-color: #28a745;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.8.0/dist/nipplejs.min.js"></script>
</head>
<body>
    <h1>Robot Current Location</h1>
    <p>Latitude: {{ gps.latitude }}</p>
    <p>Longitude: {{ gps.longitude }}</p>
    <p>Fix: {{ gps.fix }}</p>
    <p>Satellites: {{ gps.satellites }}</p>
    <p>Timestamp: {{ gps.timestamp }}</p>

    <h2>Map View</h2>
    <iframe
        width="600"
        height="450"
        style="border:0"
        loading="lazy"
        allowfullscreen
        src="https://maps.google.com/maps?q={{ gps.latitude }},{{ gps.longitude }}&z=15&output=embed">
    </iframe>

    <h2>Live Camera Feed</h2>
    <img src="{{ url_for('video_feed') }}" width="640" height="480" alt="Live Camera Feed">

    <h2>Generated Map</h2>
    <img src="{{ url_for('map_feed') }}" width="640" height="480" alt="Generated Map">

    <h2>Joystick Control</h2>
    <button id="manual-control">Enable Manual Control</button>
    <div id="joystick-zone"></div>

    <script>
        // Connect to ROSBridge
        const ros = new ROSLIB.Ros({
            url: 'ws://172.27.142.19:9090' // Update if rosbridge is on a different host/port
        });

        ros.on('connection', function() {
            console.log('Connected to ROSBridge WebSocket server.');
        });

        ros.on('error', function(error) {
            console.error('Error connecting to ROSBridge:', error);
            alert('Failed to connect to ROSBridge. Please check the connection.');
        });

        ros.on('close', function() {
            console.log('Connection to ROSBridge closed.');
        });

        // Create a ROS topic for cmd_vel
        const cmdVelTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/cmd_vel',
            messageType: 'geometry_msgs/Twist'
        });

        // Manual control toggle
        let manualControlEnabled = false;
        const manualControlButton = document.getElementById('manual-control');
        manualControlButton.addEventListener('click', function() {
            manualControlEnabled = !manualControlEnabled;
            if (manualControlEnabled) {
                manualControlButton.textContent = 'Disable Manual Control';
                manualControlButton.classList.add('active');
            } else {
                manualControlButton.textContent = 'Enable Manual Control';
                manualControlButton.classList.remove('active');

                // Stop the robot when manual control is disabled
                const stopTwist = new ROSLIB.Message({
                    linear: { x: 0.0, y: 0.0, z: 0.0 },
                    angular: { x: 0.0, y: 0.0, z: 0.0 }
                });
                cmdVelTopic.publish(stopTwist);
            }
        });

        // Initialize the joystick
        const joystickZone = document.getElementById('joystick-zone');
        const joystickManager = nipplejs.create({
            zone: joystickZone,
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'blue',
            size: 150
        });

        // Handle joystick movements
        joystickManager.on('move', function(evt, data) {
            if (manualControlEnabled && data && data.vector) {
                const linearSpeed = data.vector.y * 0.5; // Scale linear speed
                const angularSpeed = -data.vector.x * 1.0; // Scale angular speed

                // Create and send a Twist message
                const twist = new ROSLIB.Message({
                    linear: { x: linearSpeed, y: 0.0, z: 0.0 },
                    angular: { x: 0.0, y: 0.0, z: angularSpeed }
                });

                cmdVelTopic.publish(twist);
            }
        });

        // Stop the robot when the joystick is released
        joystickManager.on('end', function() {
            if (manualControlEnabled) {
                const stopTwist = new ROSLIB.Message({
                    linear: { x: 0.0, y: 0.0, z: 0.0 },
                    angular: { x: 0.0, y: 0.0, z: 0.0 }
                });

                cmdVelTopic.publish(stopTwist);
            }
        });
    </script>
</body>
</html>
